<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat + Live Video + GPS + Voice</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #messageLog { border: 1px solid #ccc; height: 150px; overflow-y: auto; margin: 10px 0; padding: 10px; }
    canvas, #map { border: 1px solid #ccc; margin-top: 10px; }
    .section { margin-bottom: 20px; }
    #map { height: 200px; width: 100%; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2>📡 WebSocket App with Voice + GPS</h2>

  <div class="section">
    <input id="roomName" placeholder="Room name" />
    <button onclick="createRoom()">Create</button>
    <button onclick="joinRoom()">Join</button>
  </div>

  <div class="section">
    <input id="textMessage" placeholder="Message" />
    <button onclick="sendMessage()">Send</button>
    <button onclick="clearMessages()">🧹 Clear</button>
  </div>

  <div class="section">
    <label>Video Quality:</label>
    <select id="videoQualitySelect">
      <option value="low240p">Low (240p)</option>
      <option value="medium" selected>Medium (720p)</option>
      <option value="high">High (1080p)</option>
    </select>
    <label>FPS:</label>
    <input type="range" id="fpsSlider" min="5" max="60" value="30">
    <span id="fpsValue">30</span> FPS
    <button onclick="toggleLiveVideo()">📷 Start Live Video</button>
  </div>

  <div class="section">
    <label>GPS Interval (s):</label>
    <input id="gpsInterval" type="number" value="5" min="1" />
    <button onclick="startGPS()">📍 Start GPS</button>
  </div>

  <div class="section">
    <button onclick="toggleVoiceCall()">🎤 Start Voice Call</button>
  </div>

  <div class="section">
    <h3>💬 Messages</h3>
    <div id="messageLog"></div>
  </div>

  <div class="section">
    <h3>🎥 Video</h3>
    <canvas id="videoCanvas" width="320" height="240"></canvas>
  </div>

  <div class="section">
    <h3>🗺️ Client Map</h3>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const ws = new WebSocket("wss://chat-643f.onrender.com");
    let currentRoom = "";
    let sendingVideo = false;
    let activeStream = null;
    let videoInterval = null;
    let gpsTimer = null;
    let voiceStream = null;
    let voiceInterval = null;
    const clientMarkers = new Map();

    ws.binaryType = "arraybuffer";
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    ws.onopen = () => log("✅ Connected");

    ws.onmessage = (event) => {
      if (typeof event.data === "string") {
        const msg = JSON.parse(event.data);
        if (msg.type === "message" && msg.text.startsWith("GPS:")) {
          const [lat, lon, id] = msg.text.slice(4).split(",");
          updateMarker(id, lat, lon);
        } else if (msg.type === "message") {
          log("💬 " + msg.text);
        }
      } else {
        // Handle binary (video or audio)
        audioCtx.decodeAudioData(event.data.slice(0)).then(buffer => {
          const source = audioCtx.createBufferSource();
          source.buffer = buffer;
          source.connect(audioCtx.destination);
          source.start();
        }).catch(() => {
          // fallback for video
          const blob = new Blob([event.data], { type: "image/jpeg" });
          const img = new Image();
          img.onload = () => {
            const canvas = document.getElementById("videoCanvas");
            const ctx = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
          };
          img.src = URL.createObjectURL(blob);
        });
      }
    };

    function createRoom() {
      currentRoom = document.getElementById("roomName").value.trim();
      ws.send(JSON.stringify({ type: "create", roomName: currentRoom }));
      log("📂 Created room: " + currentRoom);
    }

    function joinRoom() {
      currentRoom = document.getElementById("roomName").value.trim();
      ws.send(JSON.stringify({ type: "join", roomName: currentRoom }));
      log("📥 Joined room: " + currentRoom);
    }

    function sendMessage() {
      const text = document.getElementById("textMessage").value.trim();
      if (text && currentRoom) {
        ws.send(JSON.stringify({ type: "message", roomName: currentRoom, text }));
        document.getElementById("textMessage").value = "";
      }
    }

    function clearMessages() {
      document.getElementById("messageLog").innerHTML = "";
    }

    function log(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      document.getElementById("messageLog").appendChild(div);
    }

    function toggleLiveVideo() {
      if (sendingVideo) {
        clearInterval(videoInterval);
        sendingVideo = false;
        activeStream?.getTracks().forEach(t => t.stop());
        return;
      }

      const fps = parseInt(document.getElementById("fpsSlider").value);
      const constraints = {
        video: getVideoConstraints()
      };

      navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        activeStream = stream;
        const video = document.createElement("video");
        video.srcObject = stream;
        video.play();

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        videoInterval = setInterval(() => {
          if (!currentRoom || video.videoWidth === 0) return;
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          canvas.toBlob(blob => {
            ws.send(JSON.stringify({ type: "binary-image", roomName: currentRoom }));
            blob.arrayBuffer().then(buf => ws.send(buf));
          }, "image/jpeg", 0.6);
        }, 1000 / fps);

        sendingVideo = true;
      }).catch(err => log("🚫 Camera error: " + err.message));
    }

    function getVideoConstraints() {
      switch (document.getElementById("videoQualitySelect").value) {
        case "low240p": return { width: 426, height: 240 };
        case "medium": return { width: 1280, height: 720 };
        case "high": return { width: 1920, height: 1080 };
      }
    }

    function startGPS() {
      clearInterval(gpsTimer);
      const interval = parseInt(document.getElementById("gpsInterval").value) * 1000;
      gpsTimer = setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lon = pos.coords.longitude.toFixed(6);
          if (currentRoom) {
            const text = `GPS:${lat},${lon},ME`;
            ws.send(JSON.stringify({ type: "message", roomName: currentRoom, text }));
          }
        });
      }, interval);
    }

    function updateMarker(id, lat, lon) {
      const latNum = parseFloat(lat);
      const lonNum = parseFloat(lon);
      if (!clientMarkers.has(id)) {
        const marker = L.marker([latNum, lonNum]).addTo(map).bindPopup(id);
        clientMarkers.set(id, marker);
      } else {
        clientMarkers.get(id).setLatLng([latNum, lonNum]);
      }
    }

    function toggleVoiceCall() {
      if (voiceStream) {
        clearInterval(voiceInterval);
        voiceStream.getTracks().forEach(t => t.stop());
        voiceStream = null;
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        voiceStream = stream;
        const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => {
          if (currentRoom && e.data.size > 0) {
            e.data.arrayBuffer().then(buf => ws.send(buf));
          }
        };
        mediaRecorder.start(500); // send every 500ms
      });
    }

    document.getElementById("fpsSlider").addEventListener("input", e => {
      document.getElementById("fpsValue").textContent = e.target.value;
    });
  </script>
</body>
</html>

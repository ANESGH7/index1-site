<!DOCTYPE html>
<html>
<head>
  <title>WebSocket Live Chat + Video + Audio + GPS</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #videoPreview { width: 240px; }
    img.chat-image { max-width: 200px; max-height: 150px; }
    #map { width: 300px; height: 200px; }
    .section { margin-bottom: 20px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

  <h2>ğŸ›°ï¸ WebSocket Chat + Video + Audio + GPS</h2>

  <div class="section">
    <input id="roomInput" placeholder="Room name" />
    <button onclick="joinRoom()">Join</button>
  </div>

  <div class="section">
    <input id="textInput" placeholder="Text message" />
    <button onclick="sendText()">Send Text</button>
  </div>

  <div class="section">
    <input type="file" id="imageInput" accept="image/*" onchange="sendImage()" />
  </div>

  <div class="section">
    <h3>ğŸ“ Map</h3>
    <button onclick="shareGPS()">Share My GPS</button>
    <div id="map"></div>
  </div>

  <div class="section">
    <h3>ğŸ“¹ Live Video</h3>
    <video id="videoPreview" autoplay muted></video><br>
    <button onclick="toggleVideo()">ğŸ¥ Start Video</button>
  </div>

  <div class="section">
    <h3>ğŸ™ï¸ Live Audio</h3>
    <button onclick="toggleAudio()">ğŸ¤ Start Audio</button>
  </div>

  <div class="section">
    <h3>ğŸ“¨ Messages</h3>
    <div id="messages"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const ws = new WebSocket("wss://chat-643f.onrender.com"); // Your WebSocket server
    let currentRoom = null;
    let sendingVideo = false, sendingAudio = false;
    let mediaStream = null, audioStream = null, recorder = null, audioRecorder = null;
    let map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let clientStates = new Map();

    function logMessage(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      document.getElementById("messages").appendChild(div);
    }

    function joinRoom() {
      const room = document.getElementById("roomInput").value;
      if (room) {
        currentRoom = room;
        ws.send(JSON.stringify({ type: "join", roomName: room }));
        logMessage("ğŸšª Joined room: " + room);
      }
    }

    function sendText() {
      const text = document.getElementById("textInput").value;
      if (currentRoom && text) {
        ws.send(JSON.stringify({ type: "text", roomName: currentRoom, text }));
        logMessage("ğŸ“¤ You: " + text);
        document.getElementById("textInput").value = "";
      }
    }

    function sendImage() {
      const file = document.getElementById("imageInput").files[0];
      if (!file || !currentRoom) return;
      ws.send(JSON.stringify({ type: "binary-image", roomName: currentRoom }));
      file.arrayBuffer().then(buf => ws.send(buf));
    }

    function shareGPS() {
      if (!navigator.geolocation || !currentRoom) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        ws.send(JSON.stringify({ type: "gps", roomName: currentRoom, latitude, longitude }));
        logMessage(`ğŸ“ Sent location: (${latitude.toFixed(3)}, ${longitude.toFixed(3)})`);
      });
    }

    function toggleVideo() {
      if (sendingVideo) {
        recorder?.stop();
        mediaStream?.getTracks().forEach(t => t.stop());
        sendingVideo = false;
        logMessage("ğŸ›‘ Stopped video stream");
        return;
      }

      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        mediaStream = stream;
        document.getElementById("videoPreview").srcObject = stream;
        recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
        recorder.ondataavailable = e => {
          if (e.data.size > 0) {
            ws.send(JSON.stringify({ type: "binary-video", roomName: currentRoom }));
            e.data.arrayBuffer().then(buf => ws.send(buf));
          }
        };
        recorder.start(500);
        sendingVideo = true;
        logMessage("ğŸ“¹ Started video stream");
      });
    }

    function toggleAudio() {
      if (sendingAudio) {
        audioRecorder?.stop();
        audioStream?.getTracks().forEach(t => t.stop());
        sendingAudio = false;
        logMessage("ğŸ›‘ Stopped audio stream");
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        audioStream = stream;
        audioRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        audioRecorder.ondataavailable = e => {
          if (e.data.size > 0) {
            ws.send(JSON.stringify({ type: "binary-audio", roomName: currentRoom }));
            e.data.arrayBuffer().then(buf => ws.send(buf));
          }
        };
        audioRecorder.start(500);
        sendingAudio = true;
        logMessage("ğŸ™ï¸ Started audio stream");
      });
    }

    ws.onmessage = event => {
      if (event.data instanceof ArrayBuffer) {
        const blob = new Blob([event.data]);
        const url = URL.createObjectURL(blob);

        // Try image first
        const img = new Image();
        img.src = url;
        img.onload = () => {
          img.className = "chat-image";
          document.getElementById("messages").appendChild(img);
        };
        img.onerror = () => {
          // Try video
          const video = document.createElement("video");
          video.src = url;
          video.autoplay = true;
          video.muted = true;
          video.controls = false;
          video.width = 240;
          video.onerror = () => {
            // Try audio
            const audio = new Audio(url);
            audio.play();
          };
          document.getElementById("messages").appendChild(video);
        };
        return;
      }

      const msg = JSON.parse(event.data);
      if (msg.type === "text") {
        logMessage("ğŸ’¬ " + msg.text);
      } else if (msg.type === "gps") {
        const marker = L.marker([msg.latitude, msg.longitude]).addTo(map)
          .bindPopup(`ğŸ“ ${msg.latitude.toFixed(3)}, ${msg.longitude.toFixed(3)}`).openPopup();
        map.setView([msg.latitude, msg.longitude], 14);
      }
    };
  </script>
</body>
</html>

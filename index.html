<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Video, Voice, GPS Chat</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #video, #remoteVideo { width: 300px; height: auto; background: black; }
    #map { height: 300px; margin-top: 10px; }
    textarea { width: 300px; height: 80px; }
    input, select, button { margin: 5px 0; display: block; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
  <h2>WebSocket Video + Voice + GPS Chat</h2>

  <label>Room:
    <input type="text" id="roomName" value="room1" />
  </label>
  <button id="joinBtn">Join Room</button>

  <hr>

  <textarea id="chatBox" readonly></textarea>
  <input type="text" id="msgInput" placeholder="Type message..." />
  <button id="sendMsgBtn">Send Text</button>

  <hr>

  <h3>Video Stream</h3>
  <video id="video" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <label>Resolution:
    <select id="resolution">
      <option value="320x240">320x240</option>
      <option value="640x480">640x480</option>
      <option value="1280x720">1280x720</option>
    </select>
  </label>
  <label>FPS:
    <select id="fps">
      <option value="5">5</option>
      <option value="10">10</option>
      <option value="15" selected>15</option>
    </select>
  </label>
  <button id="startVideo">Start Video</button>

  <hr>

  <h3>Voice Stream</h3>
  <button id="startVoice">Start Voice</button>

  <hr>

  <h3>GPS Location</h3>
  <button id="startGPS">Share My Location</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let ws, roomName;
    const chatBox = document.getElementById("chatBox");
    const video = document.getElementById("video");
    const remoteVideo = document.getElementById("remoteVideo");
    const joinBtn = document.getElementById("joinBtn");

    joinBtn.onclick = () => {
      roomName = document.getElementById("roomName").value.trim();
      if (!roomName) return alert("Enter room name");

      ws = new WebSocket("wss://chat-643f.onrender.com");
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: "join", roomName }));
      };

      ws.onmessage = async (event) => {
        if (typeof event.data === "string") {
          const msg = JSON.parse(event.data);
          if (msg.type === "message") {
            chatBox.value += `[Text] ${msg.text}\n`;
          }
        } else {
          // binary (video or voice)
          if (expecting === "video") {
            const blob = new Blob([event.data], { type: "video/webm" });
            remoteVideo.src = URL.createObjectURL(blob);
          } else if (expecting === "audio") {
            const blob = new Blob([event.data], { type: "audio/webm" });
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
          }
        }
      };

      ws.onclose = () => {
        alert("Disconnected");
      };
    };

    // Send text
    document.getElementById("sendMsgBtn").onclick = () => {
      const text = document.getElementById("msgInput").value;
      if (ws?.readyState === 1) {
        ws.send(JSON.stringify({ type: "message", roomName, text }));
        chatBox.value += `[You] ${text}\n`;
        document.getElementById("msgInput").value = "";
      }
    };

    // Video stream
    let videoInterval;
    let expecting = "video";

    document.getElementById("startVideo").onclick = async () => {
      const [width, height] = document.getElementById("resolution").value.split("x").map(Number);
      const fps = +document.getElementById("fps").value;

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width, height, frameRate: fps }, audio: false
      });
      video.srcObject = stream;

      const track = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(track);

      if (ws?.readyState === 1) {
        ws.send(JSON.stringify({ type: "binary-video", roomName }));
      }

      videoInterval = setInterval(async () => {
        const bitmap = await imageCapture.grabFrame();
        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        canvas.getContext("2d").drawImage(bitmap, 0, 0);
        canvas.toBlob(blob => {
          if (blob && ws?.readyState === 1) {
            expecting = "video";
            blob.arrayBuffer().then(buf => ws.send(buf));
          }
        }, "video/webm");
      }, 1000 / fps);
    };

    // Voice stream
    document.getElementById("startVoice").onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0 && ws?.readyState === 1) {
          expecting = "audio";
          e.data.arrayBuffer().then(buf => ws.send(buf));
        }
      };

      if (ws?.readyState === 1) {
        ws.send(JSON.stringify({ type: "binary-audio", roomName }));
      }

      mediaRecorder.start(500); // send every 500ms
    };

    // GPS
    let map, marker;

    document.getElementById("startGPS").onclick = () => {
      if (!navigator.geolocation) {
        return alert("Geolocation not supported");
      }

      navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        if (!map) {
          map = L.map("map").setView([lat, lon], 15);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '© OpenStreetMap'
          }).addTo(map);
          marker = L.marker([lat, lon]).addTo(map);
        } else {
          marker.setLatLng([lat, lon]);
          map.panTo([lat, lon]);
        }

        if (ws?.readyState === 1) {
          ws.send(JSON.stringify({
            type: "message",
            roomName,
            text: `📍 Location: https://maps.google.com/?q=${lat},${lon}`
          }));
        }
      }, err => {
        alert("Error getting location: " + err.message);
      });
    };
  </script>
</body>
</html>

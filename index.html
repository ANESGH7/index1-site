<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat with Video + Audio + GPS</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    canvas, #map { border: 1px solid #ccc; width: 100%; }
    .section { margin-bottom: 20px; }
    #messageLog { border: 1px solid #ccc; height: 150px; overflow-y: auto; padding: 5px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2>📡 Live Video + Voice + GPS + Chat</h2>

  <div class="section">
    <input type="text" id="roomName" placeholder="Room name" />
    <button onclick="createRoom()">Create</button>
    <button onclick="joinRoom()">Join</button>
  </div>

  <div class="section">
    <input type="text" id="textMessage" placeholder="Text message" />
    <button onclick="sendMessage()">Send</button>
    <button onclick="clearMessages()">🧹 Clear</button>
  </div>

  <div class="section">
    <label>Video Quality:</label>
    <select id="videoQualitySelect">
      <option value="low240p">Low (240p)</option>
      <option value="medium" selected>Medium (720p)</option>
      <option value="high">High (1080p)</option>
    </select>
    <label>FPS:</label>
    <input type="range" id="fpsSlider" min="5" max="30" value="15" />
    <span id="fpsValue">15</span>
    <br/>
    <button onclick="toggleLive()">📷 Start Live Video + Voice</button>
  </div>

  <div class="section">
    <label>GPS Interval (s):</label>
    <input type="number" id="gpsIntervalInput" value="5" min="1" />
    <button onclick="startGps()">📍 Start GPS</button>
    <button onclick="stopGps()">🛑 Stop</button>
    <div id="gpsDisplay">Location: N/A</div>
  </div>

  <div class="section">
    <h3>Messages</h3>
    <div id="messageLog"></div>
  </div>

  <div class="section">
    <h3>🎥 Live Video</h3>
    <canvas id="videoCanvas"></canvas>
  </div>

  <div class="section">
    <h3>🔊 Audio</h3>
    <audio id="audioPlayer" autoplay></audio>
  </div>

  <div class="section">
    <h3>🗺️ Map</h3>
    <div id="map" style="height:300px;"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const ws = new WebSocket("ws://localhost:8080");
    ws.binaryType = "arraybuffer";
    let room = "", stream = null, recorder = null, gpsInterval = null, posWatch = null;
    let sending = false, videoTimer = null, clientId = Math.random().toString(36).slice(2, 10);
    let markerMap = {};

    const canvas = document.getElementById("videoCanvas");
    const ctx = canvas.getContext("2d");
    const map = L.map("map").setView([0, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    ws.onmessage = (e) => {
      if (typeof e.data === "string") {
        const msg = JSON.parse(e.data);
        if (msg.type === "message") {
          log("💬 " + msg.text);
          const m = msg.text.match(/^GPS:([-\d.]+),([-\d.]+) & (.+)$/);
          if (m) {
            const [_, lat, lng, id] = m;
            if (!markerMap[id]) {
              markerMap[id] = L.marker([lat, lng]).addTo(map).bindPopup("Client: " + id);
            } else {
              markerMap[id].setLatLng([lat, lng]);
            }
          }
        }
      } else {
        const type = new Uint8Array(e.data.slice(0, 1))[0];
        const blob = new Blob([e.data.slice(1)], {
          type: type === 1 ? "image/jpeg" : "audio/webm"
        });

        if (type === 1) {
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
          };
          img.src = URL.createObjectURL(blob);
        } else if (type === 2) {
          document.getElementById("audioPlayer").src = URL.createObjectURL(blob);
        }
      }
    };

    function createRoom() {
      room = document.getElementById("roomName").value.trim();
      ws.send(JSON.stringify({ type: "create", roomName: room }));
      log("🆕 Created room: " + room);
    }

    function joinRoom() {
      room = document.getElementById("roomName").value.trim();
      ws.send(JSON.stringify({ type: "join", roomName: room }));
      log("➡️ Joined room: " + room);
    }

    function sendMessage() {
      const text = document.getElementById("textMessage").value.trim();
      if (!room || !text) return;
      ws.send(JSON.stringify({ type: "message", roomName: room, text }));
    }

    function toggleLive() {
      if (sending) {
        sending = false;
        clearInterval(videoTimer);
        if (recorder) recorder.stop();
        if (stream) stream.getTracks().forEach(t => t.stop());
        log("🛑 Stopped live video + voice");
        return;
      }

      navigator.mediaDevices.getUserMedia(getConstraints()).then(mediaStream => {
        stream = mediaStream;
        sending = true;
        log("📹 Sending live video + audio...");

        const video = document.createElement("video");
        video.srcObject = stream;
        video.play();

        const fps = parseInt(document.getElementById("fpsSlider").value);
        const offscreen = document.createElement("canvas");
        const octx = offscreen.getContext("2d");

        videoTimer = setInterval(() => {
          if (!room || video.videoWidth === 0) return;
          offscreen.width = video.videoWidth;
          offscreen.height = video.videoHeight;
          octx.drawImage(video, 0, 0);
          offscreen.toBlob(blob => {
            if (!blob) return;
            blob.arrayBuffer().then(buf => {
              const out = new Uint8Array(buf.byteLength + 1);
              out[0] = 1;
              out.set(new Uint8Array(buf), 1);
              ws.send(out);
            });
          }, "image/jpeg", 0.6);
        }, 1000 / fps);

        recorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
        recorder.ondataavailable = e => {
          if (!e.data.size || !room) return;
          e.data.arrayBuffer().then(buf => {
            const out = new Uint8Array(buf.byteLength + 1);
            out[0] = 2;
            out.set(new Uint8Array(buf), 1);
            ws.send(out);
          });
        };
        recorder.start(1000);
      });
    }

    function getConstraints() {
      const q = document.getElementById("videoQualitySelect").value;
      if (q === "low240p") return { video: { width: 426, height: 240 }, audio: true };
      if (q === "high") return { video: { width: 1920, height: 1080 }, audio: true };
      return { video: { width: 1280, height: 720 }, audio: true };
    }

    function startGps() {
      const intv = Math.max(1, parseInt(document.getElementById("gpsIntervalInput").value));
      posWatch = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        document.getElementById("gpsDisplay").textContent = `Location: ${lat}, ${lng}`;
      });
      gpsInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          const txt = `GPS:${lat},${lng} & ${clientId}`;
          ws.send(JSON.stringify({ type: "message", roomName: room, text: txt }));
        });
      }, intv * 1000);
    }

    function stopGps() {
      clearInterval(gpsInterval);
      if (posWatch !== null) navigator.geolocation.clearWatch(posWatch);
      document.getElementById("gpsDisplay").textContent = "Location: N/A";
    }

    function log(text) {
      const div = document.createElement("div");
      div.textContent = text;
      document.getElementById("messageLog").appendChild(div);
    }

    document.getElementById("fpsSlider").oninput = e => {
      document.getElementById("fpsValue").textContent = e.target.value;
    };
  </script>
</body>
</html>

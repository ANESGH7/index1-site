const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 8080 });

console.log("âœ… Server running on ws://localhost:8080");

const rooms = new Map();

wss.on('connection', (ws) => {
  ws.room = null;

  ws.on('message', (data) => {
    if (typeof data === 'string') {
      try {
        const msg = JSON.parse(data);
        if (msg.type === 'join') {
          if (!rooms.has(msg.roomName)) rooms.set(msg.roomName, new Set());
          rooms.get(msg.roomName).add(ws);
          ws.room = msg.roomName;
          console.log(`User joined room: ${msg.roomName}`);
        } else if (msg.type === 'message' || msg.type === 'gps') {
          if (!ws.room) return;
          const group = rooms.get(ws.room);
          for (const client of group) {
            if (client !== ws && client.readyState === WebSocket.OPEN) {
              client.send(JSON.stringify(msg));
            }
          }
        }
      } catch (err) {
        console.error("Bad JSON:", err);
      }
    } else if (Buffer.isBuffer(data) && ws.room) {
      // Binary image blob (JPEG)
      const group = rooms.get(ws.room);
      for (const client of group) {
        if (client !== ws && client.readyState === WebSocket.OPEN) {
          client.send(data);
        }
      }
    }
  });

  ws.on('close', () => {
    if (ws.room && rooms.has(ws.room)) {
      rooms.get(ws.room).delete(ws);
      if (rooms.get(ws.room).size === 0) rooms.delete(ws.room);
    }
    console.log("Client disconnected.");
  });
});

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>WebSocket Chat Client</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  #messageLog { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
  #videoCanvas { border: 1px solid #ccc; width: 320px; height: 240px; display: block; margin-top: 10px; }
</style>
</head>
<body>

<h2>WebSocket Chat Client</h2>

<div>
  <input id="roomInput" placeholder="Room name" />
  <button onclick="createRoom()">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>
</div>

<div style="margin-top: 10px;">
  <input id="messageInput" placeholder="Message" />
  <button onclick="sendMessage()">Send</button>
</div>

<div id="messageLog"></div>

<canvas id="videoCanvas" width="320" height="240"></canvas>

<script>
  // Change to your WebSocket server URL here:
  const ws = new WebSocket("wss://chat-643f.onrender.com");

  ws.binaryType = "arraybuffer";

  let currentRoom = "";

  ws.onopen = () => logMessage("Connected to server");
  ws.onerror = () => logMessage("WebSocket error");
  ws.onclose = () => logMessage("Disconnected from server");

  ws.onmessage = (event) => {
    if (typeof event.data === "string") {
      // Text message (JSON)
      try {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      } catch (e) {
        logMessage("Received invalid JSON: " + event.data);
      }
    } else {
      // Binary data
      handleBinary(event.data);
    }
  };

  function logMessage(text) {
    const log = document.getElementById("messageLog");
    const div = document.createElement("div");
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  function createRoom() {
    const room = document.getElementById("roomInput").value.trim();
    if (!room) return alert("Enter room name");
    ws.send(JSON.stringify({ type: "create", roomName: room }));
  }

  function joinRoom() {
    const room = document.getElementById("roomInput").value.trim();
    if (!room) return alert("Enter room name");
    ws.send(JSON.stringify({ type: "join", roomName: room }));
    currentRoom = room;
  }

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return alert("Enter a message");
    if (!currentRoom) return alert("Join a room first");
    ws.send(JSON.stringify({ type: "message", roomName: currentRoom, text }));
    logMessage("You: " + text);
    document.getElementById("messageInput").value = "";
  }

  function handleMessage(msg) {
    switch(msg.type) {
      case "created":
        logMessage(`Room created: ${msg.roomName}`);
        break;
      case "joined":
        logMessage(`Joined room: ${msg.roomName}`);
        currentRoom = msg.roomName;
        break;
      case "message":
        logMessage(`Room message: ${msg.text}`);
        break;
      case "error":
        logMessage(`Error: ${msg.message}`);
        break;
      default:
        logMessage("Unknown message: " + JSON.stringify(msg));
    }
  }

  // Draw video frame from binary data (simulate raw RGB or similar)
  function handleBinary(data) {
    // For demo, just draw raw data as grayscale on canvas (assuming 320x240)
    const canvas = document.getElementById("videoCanvas");
    const ctx = canvas.getContext("2d");

    // Assume data is grayscale pixel array (1 byte per pixel)
    if (data.byteLength !== 320 * 240) {
      console.log("Received binary data with unexpected size:", data.byteLength);
      return;
    }

    const imageData = ctx.createImageData(320, 240);
    const bytes = new Uint8Array(data);

    for (let i = 0; i < bytes.length; i++) {
      const val = bytes[i];
      imageData.data[i*4 + 0] = val; // R
      imageData.data[i*4 + 1] = val; // G
      imageData.data[i*4 + 2] = val; // B
      imageData.data[i*4 + 3] = 255; // A
    }

    ctx.putImageData(imageData, 0, 0);
  }
</script>

</body>
</html>

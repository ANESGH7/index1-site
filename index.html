<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat + Voice Call</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #messageLog { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; margin-bottom: 20px; }
    canvas { max-width: 100%; border: 1px solid #ccc; }
    #map { height: 300px; margin-top: 10px; }
    .section { margin-bottom: 20px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <h2>📡 WebSocket Chat with Voice Call</h2>

  <div class="section">
    <input type="text" id="roomName" placeholder="Room name" />
    <button onclick="createRoom()">Create</button>
    <button onclick="joinRoom()">Join</button>
  </div>

  <div class="section">
    <input type="text" id="textMessage" placeholder="Enter message" />
    <button onclick="sendMessage()">Send</button>
    <button onclick="clearMessages()">🧹 Clear</button>
  </div>

  <div class="section">
    <label><strong>Video Quality:</strong></label>
    <select id="videoQualitySelect">
      <option value="veryLow120p">Very Low (120p)</option>
      <option value="low240p">Low (240p)</option>
      <option value="medium" selected>Medium (720p)</option>
      <option value="high">High (1080p)</option>
    </select>
    <label>FPS: <input type="range" id="fpsSlider" min="5" max="60" value="30"> <span id="fpsValue">30</span></label><br/>
    <button id="videoButton" onclick="toggleLiveVideo()">📷 Start Live Video</button>
  </div>

  <div class="section">
    <label>GPS Interval (sec):</label>
    <input type="number" id="gpsInterval" value="5" min="1" style="width: 60px;">
    <button onclick="toggleGPS()">📍 Start GPS</button>
  </div>

  <div class="section">
    <button onclick="recordVoice()">🎙️ Send Voice Message</button>
    <button onclick="toggleVoiceCall()">🎧 Start Voice Call</button>
    <audio id="audioPlayer" controls style="display:none;"></audio>
  </div>

  <div class="section">
    <h3>💬 Messages</h3>
    <div id="messageLog"></div>
  </div>

  <div class="section">
    <h3>🎥 Received Live Video</h3>
    <canvas id="videoCanvas" width="320" height="240"></canvas>
  </div>

  <div class="section">
    <h3>🗺️ GPS Map</h3>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const ws = new WebSocket("wss://chat-643f.onrender.com");
    ws.binaryType = "arraybuffer";
    let currentRoom = "";
    let sendingVideo = false;
    let videoInterval = null;
    let gpsIntervalID = null;
    let voiceCallStream = null;
    let voiceCallRecorder = null;
    let voiceCallInterval = null;
    const markers = {};

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    ws.onopen = () => logMessage("✅ Connected");

    ws.onmessage = (event) => {
      if (typeof event.data === "string") {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "message") {
            logMessage("💬 " + msg.text);
            if (msg.text.startsWith("GPS:")) {
              const gps = msg.text.match(/GPS:([\d\.\-]+),([\d\.\-]+)/);
              if (gps) {
                const lat = parseFloat(gps[1]);
                const lon = parseFloat(gps[2]);
                const id = msg.text.split('&')[1]?.trim() || msg.text;
                updateMarker(id, lat, lon);
              }
            }
          }
        } catch {
          logMessage("❗ Invalid message: " + event.data);
        }
      } else {
        const blob = new Blob([event.data]);
        const audio = document.getElementById("audioPlayer");

        if (blob.type.startsWith("audio/")) {
          audio.src = URL.createObjectURL(blob);
          audio.style.display = "block";
          audio.play();
        } else {
          const img = new Image();
          img.onload = () => {
            const canvas = document.getElementById("videoCanvas");
            const ctx = canvas.getContext("2d");
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
          };
          img.src = URL.createObjectURL(blob);
        }
      }
    };

    function updateMarker(id, lat, lon) {
      if (markers[id]) {
        markers[id].setLatLng([lat, lon]);
      } else {
        markers[id] = L.marker([lat, lon]).addTo(map).bindPopup(`Client: ${id}`);
      }
    }

    function createRoom() {
      const roomName = document.getElementById("roomName").value.trim();
      if (!roomName) return;
      currentRoom = roomName;
      ws.send(JSON.stringify({ type: "create", roomName }));
      logMessage("📂 Created room: " + roomName);
    }

    function joinRoom() {
      const roomName = document.getElementById("roomName").value.trim();
      if (!roomName) return;
      currentRoom = roomName;
      ws.send(JSON.stringify({ type: "join", roomName }));
      logMessage("📥 Joined room: " + roomName);
    }

    function sendMessage() {
      const text = document.getElementById("textMessage").value.trim();
      if (!text || !currentRoom) return;
      ws.send(JSON.stringify({ type: "message", roomName: currentRoom, text }));
      document.getElementById("textMessage").value = "";
    }

    function clearMessages() {
      document.getElementById("messageLog").innerHTML = "";
    }

    async function toggleLiveVideo() {
      const button = document.getElementById("videoButton");
      if (sendingVideo) {
        clearInterval(videoInterval);
        sendingVideo = false;
        button.textContent = "📷 Start Live Video";
        return;
      }

      const constraints = getVideoConstraints();
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      const video = document.createElement("video");
      video.srcObject = stream;
      await video.play();

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      sendingVideo = true;
      button.textContent = "🛑 Stop Live Video";

      const fps = parseInt(document.getElementById("fpsSlider").value);
      videoInterval = setInterval(() => {
        if (!currentRoom) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        canvas.toBlob(blob => {
          if (blob) {
            ws.send(JSON.stringify({ type: "binary-image", roomName: currentRoom }));
            setTimeout(() => blob.arrayBuffer().then(buf => ws.send(buf)), 20);
          }
        }, "image/jpeg", 0.6);
      }, 1000 / fps);
    }

    function getVideoConstraints() {
      switch (document.getElementById("videoQualitySelect").value) {
        case "veryLow120p": return { video: { width: 160, height: 120, frameRate: 10 } };
        case "low240p":     return { video: { width: 426, height: 240, frameRate: 15 } };
        case "high":        return { video: { width: 1920, height: 1080, frameRate: 30 } };
        default:            return { video: { width: 1280, height: 720, frameRate: 30 } };
      }
    }

    function toggleGPS() {
      if (gpsIntervalID) {
        clearInterval(gpsIntervalID);
        gpsIntervalID = null;
        logMessage("🛑 GPS stopped.");
        return;
      }

      const intervalSec = parseInt(document.getElementById("gpsInterval").value) || 5;
      gpsIntervalID = setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const msg = `GPS:${lat},${lon} & ${location.host}`;
          if (currentRoom) {
            ws.send(JSON.stringify({ type: "message", roomName: currentRoom, text: msg }));
          }
        });
      }, intervalSec * 1000);

      logMessage("📍 GPS started.");
    }

    async function recordVoice() {
      if (!currentRoom) return alert("Join a room first.");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const recorder = new MediaRecorder(stream);
      const chunks = [];

      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const buffer = await blob.arrayBuffer();
        ws.send(JSON.stringify({ type: "binary-audio", roomName: currentRoom }));
        setTimeout(() => ws.send(buffer), 50);
        stream.getTracks().forEach(t => t.stop());
        logMessage("📤 Voice message sent.");
      };

      recorder.start();
      setTimeout(() => recorder.stop(), 3000);
    }

    async function toggleVoiceCall() {
      if (voiceCallInterval) {
        clearInterval(voiceCallInterval);
        voiceCallStream.getTracks().forEach(t => t.stop());
        voiceCallStream = null;
        voiceCallInterval = null;
        logMessage("🎧 Voice call stopped.");
        return;
      }

      if (!currentRoom) return alert("Join a room first.");
      voiceCallStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const recorder = new MediaRecorder(voiceCallStream);
      recorder.ondataavailable = async e => {
        const blob = e.data;
        const buffer = await blob.arrayBuffer();
        ws.send(JSON.stringify({ type: "binary-audio", roomName: currentRoom }));
        setTimeout(() => ws.send(buffer), 20);
      };

      recorder.start(1000); // 1 sec chunk
      voiceCallInterval = recorder;
      logMessage("🎧 Voice call started.");
    }

    document.getElementById("fpsSlider").addEventListener("input", e => {
      document.getElementById("fpsValue").textContent = e.target.value;
    });

    function logMessage(text) {
      const div = document.createElement("div");
      div.textContent = text;
      document.getElementById("messageLog").appendChild(div);
      document.getElementById("messageLog").scrollTop = 99999;
    }
  </script>
</body>
</html>
